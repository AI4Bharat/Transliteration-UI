<html>
<head>
	<script src="CodeMirror-2.32/lib/codemirror.js"></script>
	<meta charset="utf-8">
<link rel="stylesheet" href="CodeMirror-2.32/lib/codemirror.css">
<script src="CodeMirror-2.32/mode/markdown/markdown.js"></script>
<script src="js/libs/jquery-1.7.1.js"></script>
<script src="js/jquery.typing-0.2.0.min.js"></script>
<script src="js/showdown.js"></script>
<style type="text/css">
body{
	background: #E7EEF2;
	-webkit-font-smoothing: antialiased;
	height: 100%
}
#popup {
	left:0;
	top: 0;
	position: absolute;
	box-shadow:3px 3px 10px rgba(0,0,0,0.5);
	overflow: auto;
	border-radius: 3px;
	z-index: 1000;
	display: none;
}
#popup select{
	 height: 100px;
}
div.CodeMirror.CodeMirror-wrap{
	width:48%;
	float:left;
	border: #333 solid 1px;
	height:95%;
}
div.preview{
	width:48%;
	float:right;
	height:95%;

	background-color: #fff;
	padding: 5px;
	overflow: auto;

	border: 1px solid black;
	box-shadow: rgba(0, 0, 0, 0.75) 0 2px 5px;
	border-radius: 3px;

}
div.preview  p{
	margin:1em 0;
}

#popup ul, #popup ul li{margin: 0; padding: 0;}

</style>
</head>

<body>
	<div>
		<script type="text/javascript">
		var items = $('#popup select option');
		isPop = false;
		var converter = new Showdown.converter();
		$(document).ready(function(){
			items.live('click',function(){
				replaceContent($(this).text());
			});

			$("#popup select").keydown(function (event) {
				console.log(event);
				if (event.keyCode == 27) {
				 		hidePopup();
				 	}
				else if (event.keyCode == 13 || event.keyCode == 9 || event.keyCode == 32) {
					var text=$(this).find(":selected").text();
				 		if(text !== undefined && text!== '') {
				 				replaceContent(text);
				 				if (event.keyCode == 13) {
					 					event.preventDefault();
					 					event.stopPropagation();
					 					ignoreTextChange = true;
					 					return true;
					 				}
				 			}
				}
			});
		});

		function replaceContent(text) {
			var w=getWordUnderCaret(myCodeMirror);
				var linech = w.start;
				var xy = myCodeMirror.charCoords(linech);
				var word = w.word;
				if ( word != ""){
					myCodeMirror.replaceRange(text,linech,w.end);
					myCodeMirror.focus();
				}
				hidePopup();
		}

		var ignoreTextChange = false;
		var myCodeMirror = CodeMirror(document.body, {
				lineNumbers: true,
				onChange: textChanged,
				lineWrapping: true,
				onKeyEvent : function (editor, e) {
				 	event = $.event.fix(e);
				 	if (event.type == "keydown")
				 	{
					 	ignoreTextChange = false;
					 	if ((event.keyCode == 13 || event.keyCode == 32) && !isPop) {
					 		// Enter/Space key pressed when popup is not active
					 		// Mostly user tries to move text around. So don't send any request
					 		// and show the popup
					 		ignoreTextChange = true;
					 	}
					 	else if (event.keyCode == 27) {
					 		hidePopup();
					 	}
					 	else if((event.keyCode === 13 || event.keyCode === 32 || event.keyCode === 40) && isPop) {
					 		if (event.keyCode === 40) {
					 			// Down arrow
					 			$("#popup select").focus();
					 		}
					 		else {
					 			var text=$("#popup select").find(":selected").text();
					 			if(text !== undefined && text!== '') {
					 				replaceContent(text);
					 				if (event.keyCode == 13) {
					 					event.preventDefault();
					 					event.stopPropagation();
					 					ignoreTextChange = true;
					 					return true;
					 				}
					 			}

					 		}
					 	}
				 	}
   				},

   				 onChange: textChanged
			});


		function showPopup(x, y, word) {
			var params = { 'input':word,'callback':'?' };
			$.ajax({
				url:'http://localhost:3003?' + $.param(params),
				dataType:'json',
				crossDomain: 'true',
				success:function (data) {
					html = "";
					first = true;
					data.forEach(function(d) {
						if (first) {
							html += '<option selected>'+ d+'</option>';
							first = false;
						}
						else {
							html += '<option>'+ d+'</option>';
						}
					});
					$('#popup > select').html(html).css('width','10em');
					$('#popup').css('display', "block")
								.css('left', x + "px")
								.css('top', (y + 15) + "px");
					isPop=true;
				}
			});
		}

		function hidePopup() {
			$('#popup').css('display', "none");
			isPop=false;
		}

		function isWordBoundary(text) {
			if (text == null || text == "" || text == " "
				|| text == "\n" || text == "." || text == "\t" || text == "\r" || text == "\"" || text == "'"
				|| text == "?" || text == "!" || text == "," || text == "(" || text == ")" || text == "\u000B" || text == "\u000C"
				|| text == "\u0085" || text == "\u2028" || text == "\u2029" || text == "\u000D" || text == "\u000A" || text == ";")
				return true;

			return false;
		}

		// Finds the word under caret and returns an object {start: {:line, :ch}, end: {:line, :ch}, :word}
		function getWordUnderCaret(editor) {
			var insertionPoint = editor.getCursor(); //{line, ch} object
			var startAt = 0;
			var endsAt = 0;
			var lastPosition = editor.getValue().length + 1;

			// Moving back till we hit a word boundary
			var caretPos = insertionPoint.ch;
			startAt = insertionPoint
			while(caretPos) {
				text = editor.getRange({line: insertionPoint.line, ch: caretPos - 1}, {line: insertionPoint.line, ch: caretPos});
				if (isWordBoundary(text)) {
					break;
				}
				--caretPos;
				startAt = {line: insertionPoint.line, ch: caretPos};

			}

			endsAt = insertionPoint
			caretPos = insertionPoint.ch;
			while(caretPos < lastPosition) {
				text = editor.getRange({line: insertionPoint.line, ch: caretPos}, {line: insertionPoint.line, ch: caretPos + 1});
				if (isWordBoundary(text)) {
					break;
				}
				++caretPos;
				endsAt = {line: insertionPoint.line, ch: caretPos}
			}

			return {start: startAt, end: endsAt, word: editor.getRange(startAt, endsAt)};
		}


		var timer;
		function textChanged(editor, from, to, text, next)
		{
			window.clearTimeout(timer);
			$('div.preview').html(converter.makeHtml(myCodeMirror.getValue()));
			if (ignoreTextChange) {
				return;
			}

			timer = window.setTimeout(function() {
				var linech = getWordUnderCaret(myCodeMirror).start;
				var xy = myCodeMirror.charCoords(linech);
				var word = getWordUnderCaret(myCodeMirror).word;
				if ( word != "")
					showPopup(xy.x, xy.y,word);
				else
					hidePopup();
			}, 50);
		}

		</script>
		<div id="popup" style="display; none;">
			<select  multiple=true>
			</select>
		</div>
	</div>
	<div class='preview'>
	</div>
</body>
</html>
