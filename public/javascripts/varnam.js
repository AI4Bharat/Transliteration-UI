(function(){function f(){e.live("click",function(){c($(this).text()),r=!0}),$(o).keydown(function(e){if(e.keyCode===u.ESCAPE)w(),p.focus();else if(v(e.keyCode)){var t=$(this).find(":selected").text();if(t!==undefined&&t!==""){c(t);if(e.keyCode==u.ENTER)return e.preventDefault(),e.stopPropagation(),r=!0,!0}}})}function c(e){var t=S(p),n=t.start,r=p.charCoords(n),i=t.word;i!=""&&(p.replaceRange(e,n,t.end),p.focus()),w(),h(e)}function h(e){var t=$("#selected_lang").data("lang");if(t==undefined||t==="en")return;$.post("learn",{text:e,lang:t})}function d(){var e=$("#popup select").find(":selected").text();e!==undefined&&e!==""&&c(e)}function v(e){var t=$.inArray(e,a)==-1?!1:!0;return t?!0:!1}function m(e,n){var i=$.event.fix(n);if(i.type!="keydown")return;r=!1;if(i.keyCode==u.ESCAPE){w();return}if(t){if(i.keyCode===u.DOWN_ARROW)return $("#popup select").focus(),i.preventDefault(),i.stopPropagation(),!0;if(v(i.keyCode)){d();if(i.keyCode===u.ENTER)return i.preventDefault(),i.stopPropagation(),r=!0,!0}}else if(i.keyCode==u.SPACE){r=!0;var s=S(p);l[s.word]=s}else v(i.keyCode)&&(r=!0)}function g(){var e=S(p),t=p.charCoords(e.start);e.word!=""?b(t.x,t.y,e.word):w()}function y(e){e?$("#network-error").fadeIn("slow"):$("#network-error").fadeOut("slow")}function b(e,n,r){var s=$("#selected_lang").data("lang");if(s==="en")return;var o={text:r,lang:s};show_error=!1,w(),i=$.ajax({url:"tl?"+$.param(o),dataType:"jsonp",crossDomain:"true",success:function(r){y(!1),html="";var i=0,s=$("#popup > select");if(l[r.input]!=undefined)wordToReplace=l[r.input],actualValueAtThatPos=p.getRange(wordToReplace.start,wordToReplace.end),actualValueAtThatPos==r.input&&p.replaceRange(r.result[0],wordToReplace.start,wordToReplace.end),delete l[r.input];else if(S(p).word==r.input){$.each(r.result,function(e,t){e===0?html+="<option selected>"+t+"</option>":html+="<option>"+t+"</option>",i<t.length&&(i=t.length),$(s).html(html).css("width",i+2+"em")}),$(s).html(html).css("height",r.result.length+1+"em");var o=$("#popup").css("display","block").css("left",e+"px").css("top",n+15+"px"),u=o.height(),a=o.width(),f=$(".CodeMirror");n+u>f.position().top+f.innerHeight()&&o.css("top",n-u+"px"),e+a>f.position().left+f.innerWidth()&&o.css("left",e-a+"px"),t=!0}},error:function(e,t,n){show_error=!0,window.setTimeout(function(){show_error&&y(!0)},2e3)}})}function w(){$("#popup").css("display","none"),t=!1}function E(e){return e==null||e==""||e==" "||e=="\n"||e=="."||e=="	"||e=="\r"||e=='"'||e=="'"||e=="?"||e=="!"||e==","||e=="("||e==")"||e==""||e=="\f"||e=="Â…"||e=="\u2028"||e=="\u2029"||e=="\r"||e=="\n"||e==";"?!0:!1}function S(e){var t=e.getCursor(),n=0,r=0,i=e.getValue().length+1,s=t.ch;n=t;while(s){text=e.getRange({line:t.line,ch:s-1},{line:t.line,ch:s});if(E(text))break;--s,n={line:t.line,ch:s}}r=t,s=t.ch;while(s<i){text=e.getRange({line:t.line,ch:s},{line:t.line,ch:s+1});if(E(text))break;++s,r={line:t.line,ch:s}}return{start:n,end:r,word:e.getRange(n,r)}}function x(e,t,n,i,o){window.clearTimeout(s),T();if(r)return;s=window.setTimeout(function(){g()},10)}function T(){if(!$("#preview_div").is(":visible"))return;var e=document.getElementById("preview");e.contentWindow.document.body.innerHTML=n.makeHtml(p.getValue())}function N(e){$("#"+e+"Btn").click()}function C(){if(typeof Storage!="undefined"&&localStorage.language){var e=JSON.parse(localStorage.language);$(".dropdown-toggle").html(e.name+" <span class='caret'></span>"),$("#selected_lang").data("lang",e.code)}}function k(e){if(typeof Storage=="undefined")return;localStorage.previewMode=e}function L(){if(typeof Storage=="undefined")return;var e=localStorage.previewMode||"both";N(e)}var e=$("#popup select option"),t=!1,n=new Showdown.converter,r=!1,i=undefined,s,o="#popup select",u={ESCAPE:27,ENTER:13,TAB:9,SPACE:32,PERIOD:190,DOWN_ARROW:40,QUESTION:191,EXCLAMATION:49,COMMA:188,LEFT_BRACKET:57,RIGHT_BRACKET:48,SEMICOLON:59},a=[u.ENTER,u.TAB,u.SPACE,u.PERIOD,u.QUESTION,u.EXCLAMATION,u.COMMA,u.LEFT_BRACKET,u.RIGHT_BRACKET,u.SEMICOLON];$(document).ready(function(){f(),L(),C()});var l={},p=CodeMirror.fromTextArea(document.getElementById("code"),{mode:"markdown",lineNumbers:!0,lineWrapping:!0,onChange:x,extraKeys:{"Ctrl-Space":function(e){g()}},onKeyEvent:m});window.onbeforeunload=function(e){e=e||window.event;if($.trim(p.getValue())!="")return e&&(e.returnValue="You will loose the text. Are you sure?"),"You will loose the text. Are you sure?"},$("button").click(function(){var e=$(this).data("preview");switch(e){case"editor":$("#editor_div").removeClass("span6").addClass("span12"),$("#preview_div").hide(),$("#editor_div").show();break;case"both":$("#editor_div").removeClass("span12").addClass("span6"),$("#preview_div").show(),$("#editor_div").show(),$("#preview_div").css("margin-left",$("#reserve").css("margin-left")),$("#preview_div").removeClass("span12").addClass("span6"),T();break;case"preview":$("#editor_div").hide(),$("#preview_div").show(),$("#preview_div").removeClass("span6").addClass("span12"),$("#preview_div").css("margin-left","0"),T()}k(e)}),$(".lang").click(function(){$(".dropdown-toggle").html($(this).text()+" <span class='caret'></span>"),$("#selected_lang").data("lang",$(this).data("lang"));if(typeof Storage=="undefined")return;localStorage.language=JSON.stringify({name:$(this).text(),code:$(this).data("lang")})}),$("#network-error-close").click(function(){y(!1)})})();