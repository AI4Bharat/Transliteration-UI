function initPreviewMode(){if(typeof Storage=="undefined")return;var e=localStorage.previewMode||"both";logglePreview(e)}function logglePreview(e){$("#"+e+"Btn").click()}function selectLastUsedLanguage(){if(typeof Storage!="undefined"&&localStorage.language){var e=JSON.parse(localStorage.language);$(".dropdown-toggle").html(e.name+" <span class='caret'></span>"),$("#selected_lang").data("lang",e.code)}}(function(){function f(){e.live("click",function(){c($(this).text()),r=!0}),$(s).keydown(function(e){if(e.keyCode===o.ESCAPE)b(),a.focus();else if(d(e.keyCode)){var t=$(this).find(":selected").text();if(t!==undefined&&t!==""){c(t);if(e.keyCode==o.ENTER)return e.preventDefault(),e.stopPropagation(),r=!0,!0}}})}function c(e){var t=E(a),n=t.start,r=a.charCoords(n),i=t.word;i!==""&&(a.replaceRange(e,n,t.end),a.focus()),b(),h(e)}function h(e){var t=$("#selected_lang").data("lang");if(t===undefined||t==="en")return;$.post("learn",{text:e,lang:t})}function p(){var e=$("#popup select").find(":selected").text();e!==undefined&&e!==""&&c(e)}function d(e){var t=$.inArray(e,u)==-1?!1:!0;return t?!0:!1}function v(e,n){var i=$.event.fix(n);if(i.type!="keydown")return;r=!1;if(i.keyCode==o.ESCAPE){b();return}if(t){if(i.keyCode===o.DOWN_ARROW)return $("#popup select").focus(),i.preventDefault(),i.stopPropagation(),!0;if(d(i.keyCode)){p();if(i.keyCode===o.ENTER)return i.preventDefault(),i.stopPropagation(),r=!0,!0}}else if(i.keyCode==o.SPACE){r=!0;var s=E(a);l[s.word]=s}else d(i.keyCode)&&(r=!0)}function m(){var e=E(a),t=a.charCoords(e.start);e.word!==""?y(t.x,t.y,e.word):b()}function g(e){e?$("#network-error").fadeIn("slow"):$("#network-error").fadeOut("slow")}function y(e,n,r){var i=$("#selected_lang").data("lang");if(i==="en")return;var s={text:r,lang:i};show_error=!1,b(),request=$.ajax({url:"tl?"+$.param(s),dataType:"jsonp",crossDomain:"true",success:function(r){g(!1),html="";var i=0,s=$("#popup > select");if(l[r.input]!==undefined)wordToReplace=l[r.input],actualValueAtThatPos=a.getRange(wordToReplace.start,wordToReplace.end),actualValueAtThatPos==r.input&&a.replaceRange(r.result[0],wordToReplace.start,wordToReplace.end),delete l[r.input];else if(E(a).word==r.input){$.each(r.result,function(e,t){e===0?html+="<option selected>"+t+"</option>":html+="<option>"+t+"</option>",i<t.length&&(i=t.length),$(s).html(html).css("width",i+2+"em")}),$(s).html(html).css("height",r.result.length+1+"em");var o=$("#popup").css("display","block").css("left",e+"px").css("top",n+15+"px"),u=o.height(),f=o.width(),c=$(".CodeMirror");n+u>c.position().top+c.innerHeight()&&o.css("top",n-u+"px"),e+f>c.position().left+c.innerWidth()&&o.css("left",e-f+"px"),t=!0}},error:function(e,t,n){show_error=!0,window.setTimeout(function(){show_error&&g(!0)},2e3)}})}function b(){$("#popup").css("display","none"),t=!1}function w(e){return e===null||e===""||e==" "||e=="\n"||e=="."||e=="	"||e=="\r"||e=='"'||e=="'"||e=="?"||e=="!"||e==","||e=="("||e==")"||e==""||e=="\f"||e=="Â…"||e=="\u2028"||e=="\u2029"||e=="\r"||e=="\n"||e==";"?!0:!1}function E(e){var t=e.getCursor(),n=0,r=0,i=e.getValue().length+1,s=t.ch;n=t;while(s){text=e.getRange({line:t.line,ch:s-1},{line:t.line,ch:s});if(w(text))break;--s,n={line:t.line,ch:s}}r=t,s=t.ch;while(s<i){text=e.getRange({line:t.line,ch:s},{line:t.line,ch:s+1});if(w(text))break;++s,r={line:t.line,ch:s}}return{start:n,end:r,word:e.getRange(n,r)}}function S(e,t,n,s,o){window.clearTimeout(i),x();if(r)return;i=window.setTimeout(function(){m()},10)}function x(e){if(!$("#preview_div").is(":visible")&&!e)return;var t=document.getElementById("preview");t.contentWindow.document.body.innerHTML=n.makeHtml(a.getValue())}function T(e){if(typeof Storage=="undefined")return;localStorage.previewMode=e}window.Varnam={};var e=$("#popup select option"),t=!1,n=new Showdown.converter,r=!1,i,s="#popup select",o={ESCAPE:27,ENTER:13,TAB:9,SPACE:32,PERIOD:190,DOWN_ARROW:40,QUESTION:191,EXCLAMATION:49,COMMA:188,LEFT_BRACKET:57,RIGHT_BRACKET:48,SEMICOLON:59},u=[o.ENTER,o.TAB,o.SPACE,o.PERIOD,o.QUESTION,o.EXCLAMATION,o.COMMA,o.LEFT_BRACKET,o.RIGHT_BRACKET,o.SEMICOLON],a=null;Varnam.init=function(e){a=CodeMirror.fromTextArea(e.textArea,{mode:e.mode,lineNumbers:e.lineNumbers,lineWrapping:!0,onChange:S,extraKeys:{"Ctrl-Space":function(e){m()}},onKeyEvent:v}),f()};var l={};$("button").click(function(){var e=$(this).data("preview");switch(e){case"editor":$("#editor_div").removeClass("span6").addClass("span12"),$("#preview_div").hide(),$("#editor_div").show();break;case"both":$("#editor_div").removeClass("span12").addClass("span6"),$("#preview_div").show(),$("#editor_div").show(),$("#preview_div").css("margin-left",$("#reserve").css("margin-left")),$("#preview_div").removeClass("span12").addClass("span6"),x();break;case"preview":$("#editor_div").hide(),$("#preview_div").show(),$("#preview_div").removeClass("span6").addClass("span12"),$("#preview_div").css("margin-left","0"),x()}T(e)}),$(".lang").click(function(){$(".dropdown-toggle").html($(this).text()+" <span class='caret'></span>"),$("#selected_lang").data("lang",$(this).data("lang"));if(typeof Storage=="undefined")return;localStorage.language=JSON.stringify({name:$(this).text(),code:$(this).data("lang")})}),$("#network-error-close").click(function(){g(!1)}),$("#printBtn").click(function(){x(!0),window.print()})})(),window.onbeforeunload=function(e){e=e||window.event;if($.trim(myCodeMirror.getValue())!=="")return e&&(e.returnValue="You will loose the text. Are you sure?"),"You will loose the text. Are you sure?"};